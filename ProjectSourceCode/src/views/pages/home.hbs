<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<link href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
<style>
  body {
    margin: 0;
    padding: 0;
    height: 100%;
  }

  #map {
    position: absolute;
    top: 0;
    bottom: 0;
    right: 5px;
    z-index: 0;
    width: 100%;
  }

  .marker {
    background-image: url('https://docs.mapbox.com/help/demos/custom-markers-gl-js/mapbox-icon.png');
    background-size: cover;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
  }

  .mapboxgl-popup {
    max-width: 200px;
  }

  .mapboxgl-popup-content {
    text-align: center;
    font-family: 'Open Sans', sans-serif;
  }

  .pos-f-t,
  .collapse {
    z-index: 10;
    position: relative;
  }
</style>

<div id="map"></div>
<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiZm90b3M0ZmFtaWx5IiwiYSI6ImNtOGh6eWx1cDA1eXMybHB1Z2kyajJqbG0ifQ.9paU93BLc6W7vG-8KuOxng';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v11',
    center: [-96, 37.8],
    zoom: 2,
  });

  // Load existing saved pins
  fetch('/api/pins')
    .then(res => res.json())
    .then(pins => {
      pins.forEach(pin => {
        const el = document.createElement('div');
        el.className = 'marker';

        const popup = new mapboxgl.Popup({ offset: 25 })
          .setHTML(`<a href="/pin/${pin.id}" class="text-primary">ðŸ“¸ Open Gallery</a>`);

        new mapboxgl.Marker(el)
          .setLngLat([pin.lng, pin.lat])
          .setPopup(popup)
          .addTo(map);
      });
    });

  // Create new pin on click
  map.on('click', function (e) {
    if (e.originalEvent.target.closest('.mapboxgl-marker') ||
        e.originalEvent.target.closest('.mapboxgl-popup')) return;

    const coords = e.lngLat;

    fetch('/api/pin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ lat: coords.lat, lng: coords.lng })
    })
    .then(res => res.json())
    .then(data => {
      const pinId = data.pinId;

      const el = document.createElement('div');
      el.className = 'marker';

      const popup = new mapboxgl.Popup({ offset: 25 })
        .setHTML(`<a href="/pin/${pinId}" class="text-primary">ðŸ“¸ Open Gallery</a>`);

      new mapboxgl.Marker(el)
        .setLngLat([coords.lng, coords.lat])
        .setPopup(popup)
        .addTo(map);
    });
  });
</script>
